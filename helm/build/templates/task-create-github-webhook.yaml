apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-github-webhook
  namespace: {{ .Release.Namespace }}
  labels:
    type: task
    backstage.io/kubernetes-id: {{ .Values.app.name }}
spec:
  params:
    - name: repo
      type: string
  steps:
    - computeResources: {}
      env:
        - name: GIT_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: {{ .Values.sealedSecrets.git.secretName }}
        - name: GIT_USERNAME
          valueFrom:
            secretKeyRef:
              key: username
              name: {{ .Values.sealedSecrets.git.secretName }}
        - name: NAMESPACE
          value: {{ .Release.Namespace }}
      image: 'quay.io/openshift/origin-cli:latest'
      name: extract-route-and-create-webhook
      script: |
        #!/bin/sh
        set -e

        echo "Extracting route..."
        GIT_WEBHOOK_URL=$(oc get route webhook-{{ .Values.app.name }}-el -n $NAMESPACE -o jsonpath='{.spec.host}')
        GIT_WEBHOOK_URL="http://${GIT_WEBHOOK_URL}"
        echo "Webhook URL: $GIT_WEBHOOK_URL"

        echo "Creating GitHub webhook..."
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $GIT_TOKEN" \
          -d "{
            \"name\": \"web\",
            \"active\": true,
            \"events\": [\"push\", \"create\"],
            \"config\": {
              \"url\": \"$GIT_WEBHOOK_URL\",
              \"content_type\": \"json\",
              \"insecure_ssl\": \"1\"
            }
          }" \
          "https://api.github.com/repos/{{ .Values.git.org }}/{{ .Values.git.name }}/hooks")
        
        HTTP_STATUS=$(echo "$RESPONSE" | tail -1 | sed 's/HTTP_STATUS://')
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "Response: $BODY"
        echo "HTTP Status: $HTTP_STATUS"
        
        if [ "$HTTP_STATUS" -eq 201 ]; then
        echo "Webhook created successfully!"
        elif [ "$HTTP_STATUS" -eq 422 ]; then
          echo "Webhook may already exist (422 - validation failed)"
        else
          echo "Failed to create webhook. Status: $HTTP_STATUS"
          exit 1
        fi
