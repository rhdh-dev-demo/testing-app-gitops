{{- if or .Values.sealedSecrets.git.enabled .Values.sealedSecrets.registry.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.app.name }}-patch-pipeline-sa
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-weight: "5"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: {{ .Values.app.name }}-patch-sa
      restartPolicy: OnFailure
      containers:
      - name: patch-serviceaccount
        image: quay.io/openshift/origin-cli:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "=== Patch Pipeline SA Job Started ==="
          echo "Namespace: {{ .Release.Namespace }}"
          echo "ServiceAccount to patch: pipeline"
          
          # Verify the pipeline SA exists
          echo "Checking if pipeline ServiceAccount exists..."
          if ! oc get sa pipeline -n {{ .Release.Namespace }} > /dev/null 2>&1; then
            echo "ERROR: pipeline ServiceAccount not found in {{ .Release.Namespace }}"
            echo "Available ServiceAccounts:"
            oc get sa -n {{ .Release.Namespace }}
            exit 1
          fi
          echo "pipeline ServiceAccount found"
          
          # Link git secret if configured
          {{- if .Values.sealedSecrets.git.enabled }}
          echo "--- Linking git secret: {{ .Values.sealedSecrets.git.secretName }} ---"
          if oc get secret {{ .Values.sealedSecrets.git.secretName }} -n {{ .Release.Namespace }} > /dev/null 2>&1; then
            oc secrets link pipeline {{ .Values.sealedSecrets.git.secretName }} --for=mount -n {{ .Release.Namespace }}
            echo "Git secret linked successfully"
          else
            echo "WARNING: Secret {{ .Values.sealedSecrets.git.secretName }} not found, skipping..."
          fi
          {{- end }}
          
          # Link registry secret for both pull and mount if enabled
          {{- if .Values.sealedSecrets.registry.enabled }}
          echo "--- Linking registry secret: {{ .Values.sealedSecrets.registry.secretName }} ---"
          if oc get secret {{ .Values.sealedSecrets.registry.secretName }} -n {{ .Release.Namespace }} > /dev/null 2>&1; then
            oc secrets link pipeline {{ .Values.sealedSecrets.registry.secretName }} --for=pull,mount -n {{ .Release.Namespace }}
            echo "Registry secret linked successfully"
          else
            echo "WARNING: Secret {{ .Values.sealedSecrets.registry.secretName }} not found, skipping..."
          fi
          {{- end }}
          
          echo "=== Final pipeline ServiceAccount state ==="
          oc get sa pipeline -n {{ .Release.Namespace }} -o yaml
          
          echo "=== Patch Pipeline SA Job Completed Successfully ==="
{{- end }}

